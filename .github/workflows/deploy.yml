name: Deploy Crowd Due Dill to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          set -e
          echo "ğŸš€ Starting deployment..."
          
          # Navigate to project directory
          cd /root/Crowd-Due-Dill/
          echo "ğŸ“ Current directory: $(pwd)"
          
          # Check git status before pull
          echo "ğŸ“‹ Git status before pull:"
          git status --porcelain
          
          # Pull latest changes (ensure SSH remote is set)
          echo "ğŸ“¥ Pulling latest changes..."
          git remote set-url origin git@github.com:Roderick111/Crowd-Due-Dill.git
          git pull origin main
          
          # Check if pull was successful
          echo "ğŸ“‹ Git status after pull:"
          git log --oneline -1
          
          # Build and deploy
          echo "ğŸ”¨ Building containers..."
          docker compose -f docker-compose.production.yml build --no-cache
          
          echo "ğŸš€ Starting services..."
          docker compose -f docker-compose.production.yml up -d
          
          # Wait for services to start
          echo "â³ Waiting for services to start..."
          sleep 30
          
          # Check container status
          echo "ğŸ“Š Container status:"
          docker compose -f docker-compose.production.yml ps
          
          # Health check
          echo "ğŸ¥ Performing health check..."
          if curl -f https://crowd-reg.beautiful-apps.com/health; then
            echo "âœ… Deployment successful"
          else
            echo "âŒ Deployment failed - showing logs:"
            docker compose -f docker-compose.production.yml logs --tail=50
            exit 1
          fi 